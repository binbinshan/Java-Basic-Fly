# MySQL中的锁
1. 数据库锁的类型？
2. Mysql的行级锁有哪两种？
3. 一定会锁指定行吗？
4. 悲观锁和乐观锁是什么？使用场景
5. mysql的死锁如何定位和解决？
6. mysql中的间隙锁和下一键锁是什么？


### 1、数据库锁的类型？
mysql的锁类型主要三种：行锁、表锁、全局锁

表锁：
1. 在myisam计算引擎中，执行查询命令的时候，一般会默认加个表共享锁(表读锁)，别的只能读不能写；myisam在写的时候，也会加个表独占锁(表写锁)，别的**不能读不能写**。
可以看出来myisam不太适合使用了，比如有个报表系统，一般凌晨的时候向mysql中插入数据，白天进行查询，这样两者相安无事；但是如果插入数据出问题了，比如到上午10点钟了还在插入，产生了严重的锁表，此时进行报表查询的话就会超时、504.

2. 在innodb计算引擎中表锁分为意向共享锁、意向排它锁：
    * 指的是加共享行锁的时候，必须先加意向共享表锁
    * 指的是加排他行锁的时候，必须先加意向排他表锁
    上述两种锁都是innodb引擎自己加的


行锁：
InnoDB是支持行锁的，MyISAM引擎就不支持行锁，这也是MyISAM被InnoDB替代的重要原因之一。
innodb中的行锁有共享锁和排他锁，共享锁，多个事务可以加共享锁读一条数据，排他锁，一个事务可以**写这条数据，其余的只能读**。

innodb会自动的给insert、update、delete的那行数据加上一个排他锁。

至于select，是不会自动加共享锁的，这是因为innodb默认事务是可重复读，利用了mvcc机制，不涉及到锁，大家都是读自己的快照，所以没问题的。

手动加共享行锁： select * from table where id=1 lock in share mode
手动加排他行锁： select * from table where id=1 for update;


全局锁：
全局锁的典型使用场景是，做全库逻辑备份，会使整个库处于只读状态。


### 2. Mysql的行级锁有哪两种？
mysql中的行级锁有排他锁和共享锁


### 3. 一定会锁指定行吗？
在innodb引擎下，你去update、insetr、delete都会自动加一个排他锁，但是select的时候不会自动加共享锁，而是走的mvcc快照读取数据。

### 4.悲观锁和乐观锁是什么？
mysql中悲观锁就是排他锁，就是我自己来干这个事情，别人不能加共享锁也不能加排他锁。
mysql中乐观锁，不需要搞锁，而是用版本号来控制，如果更新前后版本号一直就执行，如果不一致就重新查询执行。

### 5.mysql的死锁如何定位和解决？
死锁出现的情况就是加了分别持有了一把锁，但是还要去请求对方的锁，此时就会出现死锁。结果就是谁也获取不到锁。
查看日志，定位死锁的sql，找到对应代码进行分析。


### 6.mysql中的间隙锁和下一键锁是什么？

| Id | Name |
|----|------|
| 1  | A    |
| 3  | B    |
| 5  | C    |


行锁：
select * from table where id =1;
行锁会对索引列锁定，锁住的范围就是 id ∈ [1,1]的数据行。

间隙锁： 使用<= 或者 between 加锁是 会自动产生
会封锁该条记录相邻两个键之间的空白区域，防止其它事务在这个区域内插入、修改、删除数据，造成幻读，间隙锁只有在事务隔离级别 RR 中才会产生。
select * from table where id <=3;
锁住的索引值范围也就是：(-∞，1)，(1,3)，(3,5)
至于为什么要锁（3,5），因为在RR的隔离级别下，需要对比到第一个比3大的值（id），也就是5，才会终止。

下一键锁：
行锁和间隙锁的组合，它的封锁范围，既包含索引记录，又包含索引区间。
(-∞，1)，(1,3)，(3,5) 变成了(-∞，1]，(1,3]，(3,5]




