# 简述 Redis 持久化中 rdb 以及 aof 方案的优缺点

持久化的目的是做数据灾备，恢复数据，也是高可用的一环。即使我们的Redis挂了，也能迅速重启后，通过备份数据快速恢复。
Redis提供的持久化机制共两种RDB和AOF。当然如果我们要把redis当作纯粹的内存缓存使用，那么可以关闭持久化。

### RDB机制：
RDB机制，就是隔一段时间把redis里的数据备份一次。

### AOF机制：
AOF机制就是把redis写操作作为日志追加备份到日志文件里，然后通过linux os cache 隔一段时间刷到磁盘上。

### RDB的优缺点:
优点：
1. RDB会生成多个备份文件，每个备份文件代码某一时刻的redis数据，RDB适合做冷备，通过redis控制固定生成快照文件的时间，比较方便
2. RDB对redis对外提供的读写服务影响非常小，可以让redis保持高性能，因为redis主进程只需要fork一个子进程，让子进程执行磁盘IO操作来进行RDB持久化即可
3. RDB恢复速度快，AOF存放的指令日志，做数据恢复的时候，是要回放和执行所有的指令日志，来恢复出来内存中的所有数据。RDB，就是一份数据文件，恢复的时候，直接加载到内存中即可。

缺点：
1. 如果RDB备份的时间过长，在上次备份和下一次备份的时间中Redis挂掉了，那么就会丢失数据。
2. 如果RDB每次在fork子进程来执行RDB快照数据文件生成的时候，如果数据文件特别大，可能会导致对客户端提供的服务暂停数毫秒，或者甚至数秒。

### AOF的优缺点：
优点：
1. AOF可以更好的保护数据不丢失，一般AOF会每隔1秒，通过一个后台线程执行一次fsync操作，最多丢失1秒钟的数据。
2. AOF日志文件以只读追加模式写入，写入效率更高。
3. AOF日志文件即使过大的时候，出现后台重写操作(rewrite log)，也不会影响客户端的读写。

缺点：
1. AOF日志文件通常比RDB数据快照文件更大
2. 做数据恢复的时候，会比较慢，还有做冷备，定期的备份，不太方便，可能要自己手写复杂的脚本去做，做冷备不太合适
### 选择RDB还是AOF:
如果同时使用RDB和AOF，redis是默认使用AOF进行数据恢复的，因为AOF的数据更完整。

1. 不要仅仅使用RDB，因为那样会导致你丢失很多数据
2. 也不要仅仅使用AOF，因为那样有两个问题，第一，你通过AOF做冷备，没有RDB做冷备，来的恢复速度更快; 第二，RDB每次简单粗暴生成数据快照，更加健壮，可以避免AOF这种复杂的备份和恢复机制的bug
3. 综合使用AOF和RDB两种持久化机制，用AOF来保证数据不丢失，作为数据恢复的第一选择; 用RDB来做不同程度的冷备，在AOF文件都丢失或损坏不可用的时候，还可以使用RDB来进行快速的数据恢复