# 为什么要分库分表？你们是怎么进行分库分表的呢？

### 为什么分库分表啊？
首先为什么分库分表，这个原因肯定是因为高并发和大数据量。当然我们可以同时分库、分表，也可以只单独进行分库或者单独分表。

具体原因我们以一个案例来分析：
    
开始阶段：
- 现在有一个系统，注册用户20W，日活跃用户1W，每天单表的数据量也就1000，高峰期的并发也就10，此时随便搞搞就可以。

高速发展阶段：
- 然后这个系统快速发展，注册用户达到了2000W，日活跃用户10W,每天单表的数据量达到了10W，高峰期并发量达到了1000。这样搞一个月单表数据就会达到300W，突破千万条是迟早的事情，数据库勉强还能撑着，高峰期并发1000，我们部署几台机器，负载均衡搞一下，这样数据库1000QPS 也还凑合。

崩溃边缘阶段：
- 系统越做越大，注册用户上亿，日活跃用户千万，每天单表新增数据多达 50 万，单表数量已经突破千万级别，数据库磁盘容量不断消耗掉，高峰期并发达到惊人的 5000~8000，数据库已经无法支持这种级别的并发了，虽然我们可以引入mq进行削峰，但是mq堆积会很严重，这样长久系统必定崩溃。

所以数据量越大，请求量越大，那单个数据库一定扛不住。


### 什么是分表
上面说到我们单表的数据量已经突破千万了，sql执行的效率会大大降低，所以我们需要进行分表，因为超过百万级效率就会降低，所以把这个千万级的表拆分成百万级的。

举例说明具体的做法：
* 把一张表按照用户ID来进行分表，将一个用户的数据放入到一张表中，操作的时候只对这一张表操作即可。

### 什么是分库
分库就是为了高并发，比如高峰期每秒5000 - 8000的qps,这样单个数据库肯定承受不了这么大的并发，单个库最多支撑到并发 2000，一定要扩容了，而且一个健康的单库并发值你最好保持在每秒 1000 左右，不要太大。那么你可以将一个库的数据拆分到多个库中，访问的时候就访问一个库好了。


### 分库分表的优势：
1. MySQL从单机到多机，能承受的并发增加了多倍
2. 拆分为多个库，数据库服务器磁盘使用率大大降低
3. 单表数据量减少，SQL 执行效率明显提升


### 分库分表的中间件你了解吗？
分库分表中间件这里只列举两种常用的：
1. Sharding-jdbc:当当开源的，属于 client 层方案，目前已经更名为
2. Mycat:基于 Cobar 改造的，属于 proxy 层方案

<-- client层指的是以jar包形式存在在工程里面，proxy层指的是单独部署的中间服务 -->

优缺点：
* Sharding-jdbc 这种 client 层方案的优点在于不用部署，运维成本低，不需要代理层的二次转发请求，性能很高，但是如果遇到升级啥的需要各个系统都重新升级版本再发布，各个系统都需要耦合 Sharding-jdbc 的依赖；

* Mycat 这种 proxy 层方案的缺点在于需要部署，自己运维一套中间件，运维成本高，但是好处在于对于各个项目是透明的，如果遇到升级之类的都是自己中间件那里搞就行了。


### 你们是如何对数据库如何进行分表的？垂直拆分或水平拆分的？
垂直拆分：把一个有很多字段的表给拆分成多个表，或者是多个库上去。每个库表的结构都不一样，每个库表都包含部分字段。一般来说，会将较少的访问频率很高的字段放到一个表里去，然后将较多的访问频率很低的字段放到另外一个表里去。因为数据库是有缓存的，你访问频率高的行字段越少，就可以在缓存里缓存更多的行，性能就越好。

水平拆分：把一个表的数据给弄到多个库的多个表里去，但是每个库的表结构都一样，只不过每个库表放的数据是不同的，所有库表的数据加起来就是全部数据。水平拆分的意义，就是将数据均匀放更多的库里，然后用多个库来扛更高的并发，还有就是用多个库的存储容量来进行扩容。


### 分库分表的方式
无论分库还是分表，上面说的那些数据库中间件都是可以支持的。就是基本上那些中间件可以做到你分库分表之后，中间件可以根据你指定的某个字段值，比如说 userid，进行hash到对应的库上去，然后再自动hash到对应的表里去。
另外还有一种按照 range 来分，就是每个库一段连续的数据，这个一般是按比如时间范围来的，但是这种一般较少用，因为很容易产生热点问题，大量的流量都打在最新的数据上了。

range 来分，好处在于说，扩容的时候很简单，因为你只要预备好，给每个月都准备一个库就可以了，到了一个新的月份的时候，自然而然，就会写新的库了；缺点，但是大部分的请求，都是访问最新的数据。实际生产用 range，要看场景。

hash 分发，好处在于说，可以平均分配每个库的数据量和请求压力；坏处在于说扩容起来比较麻烦，会有一个数据迁移的过程，之前的数据需要重新计算 hash 值重新分配到不同的库或表。

还有就是根据 ID取模分片 和 Snowflake 分片；




