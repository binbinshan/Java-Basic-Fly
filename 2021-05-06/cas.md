# 简述 CAS 原理，什么是 ABA 问题，怎么解决？

### 什么是CAS？
有三个变量 V：要更新的变量(var)  、 E：预期值(expected) 、 N：新值(new) ，判断V是否等于E，如果等于，将V的值设置为N；如果不等，说明已经有其它线程更新了V，则当前线程放弃更新，什么都不做。

### CAS原子性
当多个线程同时使用CAS操作一个变量时，只有一个会胜出，并成功更新，其余均会失败，因为CAS是一种原子操作，它是一种系统原语，是一条CPU的原子指令，从CPU层面保证它的原子性。

### ABA问题
一个值原来是A，变成了B，又变回了A。这个时候使用CAS是检查不出变化的，但实际上却被更新了两次。

解决方案：
1. 在变量前面追加上版本号或者时间戳
2. 使用AtomicStampedReference，首先检查当前引用是否等于预期引用，并且检查当前标志是否等于预期标志，如果二者都相等，才使用CAS设置为新的值和标志。

### 循环时间长开销大
CAS多与自旋结合。如果自旋CAS长时间不成功，会占用大量的CPU资源。

解决方案：
1. 限制自旋次数，防止进入死循环。

### 只能保证一个共享变量的原子操作
解决方案：
1. AtomicReference类保证对象之间的原子性，把多个变量放到一个对象里面进行CAS操作；
2. 使用锁。锁内的临界区代码可以保证只有当前线程能操作。


### CAS的应用
Java利用CAS的乐观锁、原子性的特性高效解决了多线程的安全性问题，例如JDK1.8中的集合类ConcurrentHashMap、关键字volatile、ReentrantLock等。
