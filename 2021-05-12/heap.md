# 每日百万交易的支付系统，如何设置堆内存？

所谓的支付系统，是一个网站或者APP后台系统中非常核心的一个环节。

一个简单的支付流程的模型：
1. 用户在交易系统中提交了一个系统订单
2. 交易系统把请求提交给支付系统，支付系统并生成订单。
3. 支付系统指引用户跳转到付款页面。
4. 根据付款方式 转交 第三方付款接口。
5. 保存返回结果，进行处理。


###  1、百万级的交易支付系统哪里会出现问题呢？
不讨论高并发、数据存储等问题，只站在JVM的角度看这百万级的数据，其实就是在JVM中创建了百万个 支付订单的对象。

所以这里可能遇到的问题：
* 在JVM中频繁创建、销毁百万个订单对象 所带来的压力。


### 2、模拟

* 每秒处理多少请求?
假设用3台机器来部署交易支付系统，每天处理100W个支付订单，考虑到用户的行为一般会发生在中午或晚上的高峰期的3个小时里，基本上每台机器大概每秒处理30笔订单。

* 处理一个请求多长时间？
假设一次支付请求的处理，需要1秒钟的时间，对应情况就是每秒中会在堆中的新生代创建30个支付订单对象，经过1s后，这30个对象就可以被回收了，然后循环往复。

* 每个订单对象所需内存空间
根据支付订单类中的实例变量的类型来计算，例如 Integer 类型的变量数据是4个字节， Long 类型的变量数据是8个字节，假定每个订单对象为500字节。那么每秒30个支付订单，处理1秒，占据的内存空间是30 * 500字节 = 15000字节，大概其实也就15kb

* 大致流程
每秒30个支付请求，在堆中新生代创建30个支付订单对象，1秒后这个30个对象的引用就没有了，就成为了垃圾。
持续的创建订单，在新生代中不停的创建30个订单支付对象，新生代就会持续累加。直至新生代的空间快要满了，然后触发Minor GC,进行新生代垃圾回收。

* 完整预估
真实的线上运行，创建订单对象的时候，肯定同时还会每秒创建大量其他的对象，所以要把之前的计算结果扩大10倍~20倍。也就是每秒钟被栈内存局部变量引用的(不是垃圾对象)的对象占据内存空间大概1MB。然后每秒1MB的内存被占用，然后1秒后就变成垃圾。直至新生代的空间快要满了，然后触发Minor GC,进行新生代垃圾回收。

### 3、JVM堆内存设置
以4核8G的配置来部署服务，将-Xms(堆最小值)和-Xmx(堆最大值)设置为3G，-Xmn(新生代)设置为2G。
这样每秒1MB左右的新生代内存占用，大概半个小时才会触发一次Minor GC,不会频繁的触发Minor GC。


### 4、双11，瞬时访问量增加十倍
因为每秒新增1MB对象，然后几百秒过后，新生代快满了，自然就会触发Minor GC，回收掉里面99%的垃圾对象。但是一般双11情况下，很可能导致压力瞬间增大10倍，每秒钟支付系统不是100笔订单了，可能是每秒钟上千笔订单。不光是内存，尤其是线程资源、CPU资源、内存都会被打满。

现在假设每秒1000笔交易，那么每秒钟系统对内存的占用增加到10MB以上，甚至上百MB。并且此时1000笔交易也不再是1秒能处理完的了，可能每个请求需要几秒甚至几十秒。

此时因为处理的特别慢，大量的对象积压在新生代，触发Mionr GC后，会有几十MB的对象还存活，然后很快新生代继续被填满，再次触发Minor GC，过了几次Minor GC后，许多对象就会被移动到老年代。
往复，就算交易订单处理完毕了，老年代也会存留大量的垃圾对象，一旦老年代的垃圾对象越来越多，迟早会满，然后就会触发老年代的垃圾回收，而且这个老年代被占满的频率还很快，可能就
会频繁触发老年代的垃圾回收。

此时问题就出现了，频繁的Old GC会极大的影响系统性能。





